<!DOCTYPE html>
<html>
<head>
  <title>Isle 10 World Records</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #111; color: #fff; }
    .wr-box { background: #222; padding: 12px; border-radius: 8px; margin-bottom: 12px; }
    .lost { color: #f55; margin-top: 6px; }
    .gained { color: #5f5; margin-top: 6px; }
    a { color: #4af; text-decoration: none; }
  </style>
</head>
<body>
  <h1>Roblox: Isle 10 — All World Records</h1>
  <div id="wrs"></div>
  <div id="changes"></div>

  <script>
    const usernameCache = {};

    async function getUsername(id) {
      if (usernameCache[id]) return usernameCache[id];
      const res = await fetch(`https://www.speedrun.com/api/v1/users/${id}`);
      const data = await res.json();
      const name = data.data.names.international;
      usernameCache[id] = name;
      return name;
    }

    async function loadWRs() {
      const res = await fetch("wr.json");
      let data = await res.json();
      if (!Array.isArray(data)) data = [data];

      const container = document.getElementById("wrs");
      const changesContainer = document.getElementById("changes");
      changesContainer.innerHTML = "";

      // Get previous snapshot from localStorage
      const previousWRs = JSON.parse(localStorage.getItem("wrSnapshot") || "{}");
      const newSnapshot = {};

      for (const category of data) {
        const div = document.createElement("div");
        div.className = "wr-box";

        let runsHtml = "";
        for (const [subName, run] of Object.entries(category.runs)) {
          if (!run) {
            runsHtml += `<strong>${subName}</strong>: No WR yet<br>`;
            continue;
          }

          const usernames = await Promise.all(run.players.map(getUsername));
          runsHtml += `<strong>${subName}</strong>: ${run.time} — Players: ${usernames.join(", ")} <a href="${run.weblink}" target="_blank">View Run</a><br>`;

          // Track lost/gained records
          const prevRunPlayers = previousWRs[category.categoryId]?.runs?.[subName]?.players || [];

          // Lost WRs
          prevRunPlayers.forEach(prevPlayer => {
            if (!run.players.includes(prevPlayer)) {
              getUsername(prevPlayer).then(name => {
                const lostDiv = document.createElement("div");
                lostDiv.className = "lost";
                lostDiv.textContent = `${name} — ${subName} — lost`;
                changesContainer.appendChild(lostDiv);
              });
            }
          });

          // Gained WRs
          run.players.forEach(currPlayer => {
            if (!prevRunPlayers.includes(currPlayer)) {
              getUsername(currPlayer).then(name => {
                const gainedDiv = document.createElement("div");
                gainedDiv.className = "gained";
                gainedDiv.textContent = `${name} — ${subName} — gained`;
                changesContainer.appendChild(gainedDiv);
              });
            }
          });
        }

        div.innerHTML = `<strong>${category.categoryName}</strong><br>${runsHtml}`;
        container.appendChild(div);

        // Save current category to new snapshot
        newSnapshot[category.categoryId] = { runs: {} };
        for (const [subName, run] of Object.entries(category.runs)) {
          newSnapshot[category.categoryId].runs[subName] = {
            players: run?.players || []
          };
        }
      }

      // Save current snapshot for next refresh
      localStorage.setItem("wrSnapshot", JSON.stringify(newSnapshot));
    }

    loadWRs();
  </script>
</body>
</html>
